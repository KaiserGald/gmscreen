# install script for unlicht-server
# 7 February 2018
# Code is licensed under the MIT License
# Â© 2018 Scott Isenberg

#!/bin/bash

source data/conf/app.cfg

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
DOCKERPATH=/usr/bin/docker
BINARY_NAME=$1

if [ "$BINARY_NAME" = "" ]; then
  printf "Please enter the name of the app to be installed.\nUsage: install [APPNAME]\n"
  exit
fi
NOSPACE=[[:space:]]
if [[ $BINARY_NAME =~ $NOSPACE ]]; then
  printf "Please do not include any spaces in the app's name.\n"
  exit
fi

line="BINARY_NAME=${BINARY_NAME}"
cat data/conf/default.cfg | awk -v str=$line '{ if (NR==2) print str; else print $0 }' > data/conf/app.cfg
line="alias unlichtsrv='${DIR}/scripts/unlichtsrv'"
if [ "$(grep 'alias unlichtsrv' $HOME/.bashrc)" != "$line" ]; then
  sudo echo "alias unlichtsrv='${DIR}/scripts/unlichtsrv'" >> ~/.bashrc
fi

# write new service file
cat ${SERVICEDIR}/srvtmpl.service | sed ''s/'DESCRIPTION'/"${BINARY_NAME} Server"/'' | sed ''s~'CONDITIONPATHEXISTS'~${DOCKERPATH}~'' | sed ''s~'WORKINGDIRECTORY'~${INSTALLPATH}~'' | sed ''s~'EXECSTART'~"${DOCKERPATH} run -e RUN_ENV=\${ENV} -p=\${PORT}:8080 -v $DIR/app:/srv/${BINARY_NAME}/app ${BINARY_NAME}:\${TAG}"~'' | sed ''s~'EXSTARTPRE'~${BINPATH}~'' | sed ''s~'SYSLOGIDENTIFIER'~${BINARY_NAME}~'' > $SERVICECONFIG
sudo cp $SERVICECONFIG $LOCALSERVICEDIR

printf "#!/bin/bash\nsudo journalctl -f -n 20 -u $BINARY_NAME -o cat" > ${BINARY_NAME}_log
sudo chmod +x ${BINARY_NAME}_log
